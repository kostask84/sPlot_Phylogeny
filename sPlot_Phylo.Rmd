---
title: "Phylogenetic tree for the taxa in sPlot 2.1"
author: Oliver Purschke
keywords: database, big data, phylogeny, taxonomy
date: "`r format(Sys.time(), '%d %B, %Y')`"
disqusIdentifier: 2c5a0040
tags: 
- database
- big data
- traits
- taxonomy
output:
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
  html_document:
    number_sections: true
    toc: true
    toc_depth: 2
    theme: united	
abstract: "This document describes the workflow (with contributions from Brody Sandel) that was used to generate the phylogenetic tree for the taxa in the global vegetation plot database sPlot (v. 2.1)."
urlcolor: blue
bibliography: bibliography.bib
csl: journal-of-ecology.csl
# header-includes:
#   - \usepackage{lineno}
#   - \linenumbers
---

# Load required packages
```{r, echo = T, eval = T, quiet = T}
library(ape)
library(geiger)
library(dplyr)
```

```{r, echo = F, eval = F}
library(rmarkdown)
render("sPlot_Phylo.Rmd", c("html_document", "pdf_document"))
```

# Select taxon names in sPlot that are not in the reference phylogeny

## Load the sPlot taxonomic backbone

```{r, echo = F, eval = F}
# githubURL <- "https://rawgit.com/oliverpurschke/Taxonomic_Backbone/master/backbone.splot2.1.try3.is.vascular.Rdata"
# load(url(githubURL))
```

```{r, echo = T, eval = F}
load("../backbone.splot2.1.try3.is.vascular.Rdata")
```

```{r, echo = T, eval = T}
head(backbone.splot2.1.try3[,c(2,32,34,35)])
tail(backbone.splot2.1.try3[,c(2,32,34,35)])
```

## Select taxon names in sPlot
Because the taxonomic backbone includes combines and standardizes names from both, the sPlot and TRY databases, we need to exclude those names that are only found in the TRY database:

```{r, echo = T, eval = T}
splot.nam <- backbone.splot2.1.try3[backbone.splot2.1.try3$sPlot.TRY != "T", c(4,32)]
```
How many entries in the backbone are only found in sPlot (S) as well as in both, sPlot and TRY (ST)?
```{r, echo = T, eval = T}
table(splot.nam$sPlot.TRY)
```
Generate vector of unique names.
```{r, echo = T, eval = T}
splot.nam.2 <- unique(splot.nam$name.short.correct)
```

Check for `NA` entries and get rid of them:
```{r, echo = T, eval = T}
any(is.na(splot.nam.2))
na.ind <- which(is.na(splot.nam.2))
splot.nam.3 <- splot.nam.2[-na.ind]
any(is.na(splot.nam.3))
length(splot.nam.3)
```

There are 61,214 unique names in the backbone that belong to sPlot as well to sPlot and TRY. However, some of them are non-vascular names and/or are only found in the previous version of sPlot (`sPlot 2.0`) but not in `sPlot 2.1`, which will be dealt with the last section.

Insert underscores to make names match with the `tip.labels` of the phylogeny.
```{r, echo = T, eval = F}
splot.nam.4 <- gsub(" ", "_", splot.nam.3)
```

## Select taxa in sPlot that are not in the phylogeny
I started with the fully resolved reference phylogeny for 31,749 vascular plants by @zanne2014, that was generated by David Tank and folks and therefore is referred to as `tank tree` in the subsequent text.

```{r, echo = T, eval = F}
tank.tree <- read.tree("/home/oliver/Dokumente/PhD/PostPhD/IDiv/sDiv/sPlot/Analyses/Data/Phylogeny/2/PhylogeneticResources/Vascular_Plants_rooted.dated.tre")
```

```{r, echo = T, eval = T}
ind.miss <- splot.nam.4 %in% tank.tree$tip.label 
```
 
How many taxon names in sPlot are found/not found in the tank tree?:
```{r, echo = T, eval = T}
table(ind.miss)
```

Only 25.2% of the taxa in sPlot are in the tank tree. 

Before grafting the missing taxa onto the reference phylogeny, we might inspect those taxa, to see whether there are taxa that obviously should be in the tree.


Generate vector of the 45,784 names in sPlot that missing from the tree. 
```{r, echo = T, eval = T}
splot.nam.miss <- splot.nam.4[ind.miss==F]
```

Before grafting the missing species onto the reference phylogeny, we might inspect missing species to see whether there are species that obviously should be there.

```{r, echo = T, eval = F}
write.csv(sort(splot.nam.miss), file = "splot.nam.miss.csv")
```

```{r, echo = T, eval = T}
length(splot.nam.miss)
```

# Grafting missing taxa onto the reference tree
## Tree grafting function (`R`-code by Brody Sandel, Dec 2, 2014)

The following function `addCongeners` takes a tree and species list, each containing "Genus_species" or "Genus" formatted names. For each species in the list, if it has a congener on the tree but is not itself on the tree, add it next to a randomly selected congener at a random position along the edge returns a larger tree (see also the approach that was used to generate the BIEN-Phylogeny [@Maitner2017] [here](http://bien.nceas.ucsb.edu/bien/biendata/bien-2/phylogeny/)). Such approach has been demonstrated to introduce less bias into subsequent analysis than adding missing species as polytomies to the respective genera [@davies2012]. I did not add species based on taxonomic information above genus level.

```{r, echo = T, eval = T}
addCongeners = function(tree,speciesToAdd){
    resample <- function(x, ...) x[sample.int(length(x), ...)]
    staGenus = unlist(lapply(strsplit(speciesToAdd,"_"),function(i){i[[1]]}))
    gtree = tree
    for(i in sample(1:length(speciesToAdd),length(speciesToAdd),replace = F)){
        gtreeGenera = unlist(lapply(strsplit(gtree$tip,"_"),function(i){i[[1]]}))
        #If the species isn't on the tree but a congener is
        if(!speciesToAdd[i] %in% tree$tip.label & staGenus[i] %in% gtreeGenera){
            branchName = gtree$tip[resample(which(gtreeGenera == staGenus[i]),1)]
            newtree = sim.bdtree(n=2)
            newtree$tip.label = c(branchName,speciesToAdd[i])
            edgeL = gtree$edge.length[which.edge(gtree,branchName)]
            #Splice in at a random depth between 0 and 1
            depth = runif(1,0,1)
            newtree$edge.length = depth*newtree$edge.length*edgeL/max(newtree$edge.length)
            whereToGraft = which(gtree$tip == branchName)
            gtree = bind.tree(gtree,newtree,where = whereToGraft,position = edgeL*depth)
            #The grafting process duplicates the branchName tip. Drop one of them.
            gtree = drop.tip(gtree, which(gtree$tip == branchName)[1])}
    }
    return(gtree)
}
```

## Run `addCongeners` function

```{r, echo = T, eval = F}
tank.tree.added <- addCongeners(tank.tree, splot.nam.miss)
splot2.1.tank.tree.70287 <- tank.tree.added

```
Took 4.5 hours (on the RStudio-server) to add the missing 45,784 taxa in sPlot that were not included in the tank tree. This resulted in an extended tank tree with 70,287 taxa.

### Read in the full extended tree
... and check which names could not be added:

```{r, echo = T, eval = F}
splot2.1.tank.tree.70287 <- read.tree("/home/oliver/Dokumente/PhD/PostPhD/IDiv/sDiv/sPlot/Analyses/Data/Phylogeny/sPlot2.1Phylo/splot2.1.tank.tree.70287.tre")
ind.miss.2 <- splot.nam.miss %in% splot2.1.tank.tree.70287$tip.label 
splot.nam.miss.2 <- splot.nam.miss[ind.miss.2==F]
write.csv(sort(splot.nam.miss.2), file = "splot.nam.miss.2.csv")
length(splot.nam.miss.2)
```

```{r, echo = T, eval = T}
length(splot.nam.miss.2)
```

Because they had no congeners in the reference phylogeny, 7,246 species could not be added (11.8% of all resolved taxa in sPlot). This resulted in a phylogeny with 53,967 names from a total of 61,214 standardized taxa in sPlot. Anyway, lichens, mosses as well as species that are not found in sPlot 2.1 are still included in that sPlot species list. We will take care of that in a later section.

## Graft species onto the updated @qian2016 tree
The reference phylogeny by @zanne2014 has recently been updated by @qian2016, subsequently referred to as the `Qian tree`. So we will use that tree to generate our final phylogeny.

### How many taxa are missing from the Qian tree?

```{r, echo = T, eval = F}
phyto.phylo.tree <- read.tree("/home/oliver/Dokumente/PhD/PostPhD/IDiv/sDiv/sPlot/Analyses/Data/Phylogeny/Qian_PhytoPhylo/AppendixS5/PhytoPhylo.tre")
ind.miss <- splot.nam.4 %in% phyto.phylo.tree$tip.label 
```

```{r, echo = T, eval = T}
table(ind.miss)
```
16,121 names in sPlot are found in the Qian tree.

Generate vector of missing names:
```{r, echo = T, eval = F}
splot.nam.miss.phyto.phylo <- splot.nam.4[ind.miss==F]
```

### Run `addCongeners` on the Qian tree

```{r, echo = T, eval = F}
phyto.phylo.tree.added <- addCongeners(phyto.phylo.tree, splot.nam.miss.phyto.phylo)
phyto.phylo.splot2.1.69335 <- phyto.phylo.tree.added
```

This resulted in an extended Qian tree with 69,335 taxa.

```{r, echo = T, eval = F}
phyto.phylo.splot2.1.69335 <- read.tree("/home/oliver/Dokumente/PhD/PostPhD/IDiv/sDiv/sPlot/Analyses/Data/Phylogeny/sPlot2.1Phylo/phyto.phylo.splot2.1.69335.tre")

pdf("phyto.phylo.tree.splot.69335.pdf", height = 150, width = 150)
plot(phyto.phylo.splot2.1.69335, "f", cex = .1)
dev.off()

ind.miss.3 <- splot.nam.miss.phyto.phylo %in% phyto.phylo.splot2.1.69335$tip.label 
```

How many taxa in sPlot could/could not be added to the @qian2016 tree?:
```{r, echo = T, eval = T}
table(ind.miss.3)
```

```{r, echo = T, eval = F}
splot.nam.miss.3 <- splot.nam.miss.phyto.phylo[ind.miss.3==F]
write.csv(sort(splot.nam.miss.3), file = "splot.nam.miss.3.csv")

```

### Prune tree to taxa in sPlot

```{r, echo = T, eval = F}
pruned.tree <- drop.tip(phyto.phylo.splot2.1.69335, setdiff(phyto.phylo.splot2.1.69335$tip.label, splot.nam.4))

phyto.phylo.splot2.1.54067 <- pruned.tree

write.tree(phyto.phylo.splot2.1.54067, file = "phyto.phylo.splot2.1.54067.tre")

phyto.phylo.splot2.1.54067 <- read.tree("phyto.phylo.splot2.1.54067.tre")
```

```{r, echo = T, eval = F}
16121/54067
```

Out of the total of 54,067 species that are now in the sPlot2.1 tree, 29.8% are actually found in the Qian tree. The remainder was added as congeners.

### Plot the phylogeny

```{r, echo = T, eval = F}
pdf("phyto.phylo.tree.splot.54067.pdf", height = 220, width = 220)
plot(phyto.phylo.splot2.1.54067, "f", edge.width = .4, label.offset = .03, cex = .1)
dev.off()

png("phyto.phylo.tree.splot.54067.png", height = 10000, width = 10000, pointsize = 1, res = 4000)
plot(phyto.phylo.splot2.1.54067, "f", edge.width = .1, label.offset = .03, cex = .1)
dev.off()
```

### Tree for only vascular taxa in the most recent sPlot version (sPlot 2.1)
Select the respective set of species from the backbone.

Exclude `NA` entries from the backbone:
```{r, echo = T, eval = F}
ind2.1 <- !is.na(backbone.splot2.1.try3$sPlot2.1.TRY)
back2.1 <- backbone.splot2.1.try3[ind2.1, ]
```

Generate a version of the backbone that only includes the unique resolved names in `name.short.correct`. For the non-unique names, keep the first row of duplicated names:

```{r, echo = T, eval = F}
back2.1.uni <- back2.1[!duplicated(back2.1$name.short.correct), ]
back2.1.uni <- back2.1.uni[-1, ]
```

```{r, echo = T, eval = T}
length(unique(back2.1.uni$name.short.correct))
```

Select vascular species only and exclude `NA` entries:
```{r, echo = T, eval = F}
df.uni <- back2.1.uni %>%
    dplyr::filter(is.vascular.species == TRUE, !is.na(name.short.correct))
```

```{r, echo = T, eval = T}
length(df.uni$name.short.correct)
table(df.uni$sPlot2.1.TRY)
```

### Select names in sPlot 2.1

```{r, echo = T, eval = F}
df.uni.splot <- df.uni %>%
    dplyr::filter(is.vascular.species == TRUE, !is.na(name.short.correct), df.uni$sPlot2.1.TRY!= "T")
```

```{r, echo = T, eval = T}
length((df.uni.splot$name.short.correct))
splot_2.1_vasc_nam <- df.uni.splot$name.short.correct
length(splot_2.1_vasc_nam)
splot_2.1_vasc_nam_2 <- gsub(" ", "_", splot_2.1_vasc_nam)
```

# Final tree 
## Prune tree to vascular plant taxa in sPlot 2.1
```{r, echo = T, eval = F}
pruned.tree.splot2.1 <- drop.tip(phyto.phylo.splot2.1.69335, setdiff(phyto.phylo.splot2.1.69335$tip.label, splot_2.1_vasc_nam_2))

phyto.phylo.splot2.1.50167.vasc <- pruned.tree.splot2.1

write.tree(phyto.phylo.splot2.1.50167.vasc, file = "phyto.phylo.splot2.1.50167.vasc.tre")

phyto.phylo.splot2.1.50167.vasc <- read.tree("phyto.phylo.splot2.1.50167.vasc.tre")

pdf("phyto.phylo.splot2.1.50167.vasc.pdf", height = 220, width = 220)
plot(phyto.phylo.splot2.1.50167.vasc, "f", edge.width = .4, label.offset = .03, cex = .1)
dev.off()

png("phyto.phylo.splot2.1.50167.vasc.png", height = 10000, width = 10000, pointsize = 1, res = 4000)
plot(phyto.phylo.splot2.1.50167.vasc, "f", edge.width = .1, label.offset = .03, cex = .1)
dev.off()

```

```{r, out.width = "470px"}
knitr::include_graphics("/home/oliver/Dokumente/PhD/PostPhD/IDiv/sDiv/sPlot/Analyses/Code/sPlot_Phylogeny/phyto.phylo.splot2.1.50167.vasc_small.png")
```

## Some stats

From a total of 54,519 vascular taxon names in sPlot 2.1, 50,167 names (92%) are contained in the extended version of the Qian tree (extended by the names in sPlot 2.1).

How many vascular species in sPlot 2.1 are found in the Qian-tree?:

```{r, echo = T, eval = T}
ind.miss <- splot_2.1_vasc_nam_2 %in% phyto.phylo.tree$tip.label 
table(ind.miss)
```

There are 14,760 vascular names in sPlot 2.1 that are also found in the Qian reference tree (which contains 31,389 names), which are 47% from the total number of taxa in the Qian tree.

Of the in total 54,519 vascular taxon names in sPlot 2.1, 14,760 names (27.1%) are contained in the Qian tree.

--------------------

# `R`-settings

```{r, eval = T}
sessionInfo()
```

# References
